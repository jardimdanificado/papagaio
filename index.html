<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ¦œ papagaio</title>
</head>
<body>
    
    <h1>ðŸ¦œ papagaio </h1>
    <p>
        easy yet powerful text preprocessor.
    </p>
    <hr>
    <div>
        <strong>
            <label for="sketchSelect">Current Sketch:</label>
        </strong>

        <select id="sketchSelect" onchange="switchSketch()">
            <option value="">-- Select Sketch --</option>
        </select>
        |
        <button onclick="createNewSketch()">New Sketch</button>
        <button onclick="renameCurrentSketch()">Rename</button>
        <button onclick="deleteCurrentSketch()">Delete</button>
    </div>
    <hr>
    <div>
        <strong>
        <label for="sketchSelect">Sketches:</label>
        </strong>
        <button onclick="exportSketches()">Export</button>
        <input type="file" id="importFileInput" onchange="importSketches(this.files[0])" accept=".json">
    </div>
    
    <hr>
    
    <h3>INPUT</h3>
    <textarea id="input" rows="15" cols="80" style="width: 70%; font-family: monospace;"></textarea>
    
    <br><br>
    
    <button onclick="processCode()">Process</button>
    
    <br><br>
    
    <h3>OUTPUT</h3>
    <textarea id="output" rows="15" cols="80" style="width: 70%; font-family: monospace;" readonly></textarea>

    <script type="module">
        import { Papagaio } from './src/papagaio.js';

        class SketchesManager {
            constructor() {
                this.sketches = this.loadSketches();
                this.currentSketchId = this.loadCurrentSketchId();
            }

            loadSketches() {
                try {
                    const saved = localStorage.getItem('papagaio_sketches');
                    return saved ? JSON.parse(saved) : {};
                } catch {
                    return {};
                }
            }

            saveSketches() {
                try {
                    localStorage.setItem('papagaio_sketches', JSON.stringify(this.sketches));
                } catch {}
            }

            loadCurrentSketchId() {
                try {
                    return localStorage.getItem('papagaio_current_sketch');
                } catch {
                    return null;
                }
            }

            setCurrentSketchId(id) {
                this.currentSketchId = id;
                try {
                    localStorage.setItem('papagaio_current_sketch', id);
                } catch {}
            }

            createSketch(name) {
                const id = Date.now().toString();
                this.sketches[id] = {
                    id,
                    name,
                    input: '',
                    createdAt: new Date().toLocaleString()
                };
                this.saveSketches();
                this.setCurrentSketchId(id);
                return id;
            }

            getSketch(id) {
                return this.sketches[id] || null;
            }

            updateSketch(id, data) {
                if (this.sketches[id]) {
                    Object.assign(this.sketches[id], data);
                    this.saveSketches();
                }
            }

            deleteSketch(id) {
                delete this.sketches[id];
                this.saveSketches();
                if (this.currentSketchId === id) {
                    const remaining = Object.keys(this.sketches);
                    this.currentSketchId = remaining.length > 0 ? remaining[0] : null;
                    if (this.currentSketchId) {
                        this.setCurrentSketchId(this.currentSketchId);
                    }
                }
            }

            getAllSketches() {
                return Object.values(this.sketches).sort((a, b) => 
                    parseInt(b.id) - parseInt(a.id)
                );
            }

            renameSketch(id, newName) {
                if (this.sketches[id]) {
                    this.sketches[id].name = newName;
                    this.saveSketches();
                }
            }
        }

        let processor = new Papagaio();
        let sketchesManager;

        window.addEventListener('load', () => {
            sketchesManager = new SketchesManager();
            loadOrCreateDefaultSketch();
            populateSketchSelect();
        });

        function loadOrCreateDefaultSketch() {
            let sketch = null;
            if (sketchesManager.currentSketchId) {
                sketch = sketchesManager.getSketch(sketchesManager.currentSketchId);
            }
            
            if (!sketch) {
                const allSketches = sketchesManager.getAllSketches();
                if (allSketches.length > 0) {
                    sketch = allSketches[0];
                    sketchesManager.setCurrentSketchId(sketch.id);
                } else {
                    const id = sketchesManager.createSketch('Default');
                    sketch = sketchesManager.getSketch(id);
                }
            }
            
            if (sketch) {
                document.getElementById('input').value = sketch.input;
                document.getElementById('output').value = '';
            }
        }

        function saveCurrentSketch() {
            if (sketchesManager.currentSketchId) {
                sketchesManager.updateSketch(sketchesManager.currentSketchId, {
                    input: document.getElementById('input').value
                });
            }
        }

        function populateSketchSelect() {
            const select = document.getElementById('sketchSelect');
            select.innerHTML = '<option value="">-- Select Sketch --</option>';
            
            const sketches = sketchesManager.getAllSketches();
            sketches.forEach(sketch => {
                const option = document.createElement('option');
                option.value = sketch.id;
                option.textContent = sketch.name;
                if (sketch.id === sketchesManager.currentSketchId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function switchSketch() {
            const select = document.getElementById('sketchSelect');
            const id = select.value;
            
            if (!id) return;
            
            saveCurrentSketch();
            sketchesManager.setCurrentSketchId(id);
            const sketch = sketchesManager.getSketch(id);
            
            if (sketch) {
                document.getElementById('input').value = sketch.input;
                document.getElementById('output').value = '';
            }
        }

        function createNewSketch() {
            const name = prompt('Enter sketch name:');
            if (!name || !name.trim()) {
                alert('Please enter a valid sketch name');
                return;
            }
            
            const id = sketchesManager.createSketch(name.trim());
            populateSketchSelect();
            
            const sketch = sketchesManager.getSketch(id);
            if (sketch) {
                document.getElementById('input').value = sketch.input;
                document.getElementById('output').value = '';
            }
        }

        function renameCurrentSketch() {
            if (!sketchesManager.currentSketchId) {
                alert('No sketch selected');
                return;
            }
            
            const sketch = sketchesManager.getSketch(sketchesManager.currentSketchId);
            const newName = prompt('Enter new name:', sketch.name);
            
            if (!newName || !newName.trim()) {
                alert('Please enter a valid name');
                return;
            }
            
            sketchesManager.renameSketch(sketchesManager.currentSketchId, newName.trim());
            populateSketchSelect();
        }

        function deleteCurrentSketch() {
            if (!sketchesManager.currentSketchId) {
                alert('No sketch selected');
                return;
            }
            
            const sketch = sketchesManager.getSketch(sketchesManager.currentSketchId);
            
            if (!confirm(`Are you sure you want to delete "${sketch.name}"? This action cannot be undone.`)) {
                return;
            }
            
            sketchesManager.deleteSketch(sketchesManager.currentSketchId);
            loadOrCreateDefaultSketch();
            populateSketchSelect();
        }

        function processCode() {
            try {
                const input = document.getElementById('input').value;
                const output = processor.process(input);
                document.getElementById('output').value = output;
                saveCurrentSketch();
            } catch (err) {
                document.getElementById('output').value = `Error: ${err.message}`;
            }
        }

        function exportSketches() {
            const data = {
                papagaio_sketches: localStorage.getItem('papagaio_sketches'),
                papagaio_current_sketch: localStorage.getItem('papagaio_current_sketch'),
                papagaio_config: localStorage.getItem('papagaio_config')
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: "application/json"
            });

            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `papagaio_sketches_${Date.now()}.json`;
            a.click();
        }

        function importSketches(file) {
            if (!file) return;
            
            const reader = new FileReader();

            reader.onload = () => {
                try {
                    const data = JSON.parse(reader.result);
                    if (data.papagaio_sketches) {
                        localStorage.setItem('papagaio_sketches', data.papagaio_sketches);
                    }
                    if (data.papagaio_current_sketch) {
                        localStorage.setItem('papagaio_current_sketch', data.papagaio_current_sketch);
                    }
                    if (data.papagaio_config) {
                        localStorage.setItem('papagaio_config', data.papagaio_config);
                    }
                    location.reload();
                } catch (err) {
                    alert('Error importing file: ' + err.message);
                }
            };

            reader.readAsText(file);
        }

        setInterval(() => {
            saveCurrentSketch();
        }, 1000);

        window.processCode = processCode;
        window.switchSketch = switchSketch;
        window.createNewSketch = createNewSketch;
        window.renameCurrentSketch = renameCurrentSketch;
        window.deleteCurrentSketch = deleteCurrentSketch;
        window.exportSketches = exportSketches;
        window.importSketches = importSketches;
    </script>
</body>
</html>